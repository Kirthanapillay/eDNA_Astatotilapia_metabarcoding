#Mian figures for manuscript
#use phyloseq object created after filtering : ps_re_COI_edit_prune

#trasnform to relative read abundance
ps_re_COI_edit_RA <- transform_sample_counts(ps_re_COI_edit_prune, function(x) x / sum(x) )ps_re_COI_edit_RA <- prune_samples(sample_sums(ps_re_COI_edit_RA)>0, ps_re_COI_edit_RA)

#make to long format using psemlt function in phyloseq


COI_pruned_RA.smelt <- ps_re_COI_edit_RA  %>%  psmelt()#Group low abundance taxa togetherCOI_order <- COI_pruned_RA.smelt %>%  select(OTU, Sample, Abundance, SampleSite, sample_Sample, Order) %>%  group_by(SampleSite) %>%  mutate(totalSum = sum(Abundance)) %>%  ungroup() %>%  group_by(OTU, Sample, totalSum, SampleSite, sample_Sample,Order) %>%  summarise(    Abundance = sum(Abundance),    Order = ifelse(Abundance < 0.05, "Others", Order)) %>%               #change Genus label to group low abundance taxa together  group_by(OTU, Sample, totalSum, SampleSite, sample_Sample,Order) %>%  #now group and summarize again to group newly labeled low abundance taxa together  summarise(    Abundance = sum(Abundance),    RelAb = Abundance/totalSum) %>%  unique()#export file to rename undertermined order to undetermined_arthropodawrite.csv(COI_order, "COI_order.csv")
COI_order_edit <- read.csv("COI_order.csv", header = T, row.names=1)COI_order_edit <- subset(COI_order_edit, SampleSite %in% c("Benthic", "Littoral"))


#assign colours to corresponding taxamycolors_COI <- c( "#67000D", "#A50F15", "#CB181D", "#EF3B2C", "#FB6A4A", "#FC9272", "#FCBBA1", "#FEE0D2","#FFF5F0",                    "#31A354",  "#A1D99B", "#E5F5E0",                   "#4292C6", "#6BAED6",  "#9ECAE1", "#C6DBEF",                   "#CCCC00", "goldenrod4", "#FFB266", "#3399FF", "#CC99FF", "olivedrab",                   "#99FFFF", "#000099", "#6A3D9A", "#FFFF99", "#E0E0E0")COI_barplot <- ggplot(COI_order_edit) +   geom_bar(aes(x = SampleSite,  y = Abundance, fill = factor(Order, levels=c("Amphipoda", "Coleoptera", "Crassiclitellata", "Cyclopoida",                                                                         "Diptera", "Ephemeroptera", "Hymenoptera", "Lepidoptera", "Undetermined_arthropoda",                                                                         "Melosirales", "Naviculales", "Undetermined_bacillariophyta",                                                                         "Saccharomycetales", "Xylariales", "Hypocreales", "Undetermined_ascomycota",                                                                         "Agaricales", "Pythiales", "Spongillida",                                                                          "Unionida", "Venerida", "Tubificida",                                                                          "Undetermined_chlorophyta", "Undetermined_cnidaria",                                                                         "Undetermined_platyhelminthes", "Others"))), position="fill",stat = "identity") +  #facet_wrap(~SampleSite, scales = "free") +  theme_bw() +  #scale_y_continuous(expand=c(0,0)) +  ggtitle("A") + xlab("Ecotype") +  scale_fill_manual(values = mycolors_COI)+  #scale_y_continuous(limits = c(0,1), expand = c(0, 0)) +  theme(panel.background = element_blank(),        panel.border = element_rect(fill = NA, linewidth = 1),        strip.background = element_rect(fill = "white",                                         color = "white", linewidth = 1),        #axis.text.x=element_blank(),        #axis.ticks.x=element_blank(),        #axis.title.x=element_blank(),        text = element_text(size = 18),        panel.grid.major = element_blank(),        legend.position="none",        panel.grid.minor = element_blank())Figure 4ggsave("COI_barplot.pdf", width = 16, height = 12, dpi = 300)

#Figure 5 is similar but with 18S data instead

